# Stage1: Visual-Language Alignment Training
# ä»…è®­ç»ƒ MLP Projectionï¼Œå†»ç»“ CLIP å’Œ Qwen3

direction: down

title: {
  label: "Stage1: è§†è§‰-è¯­è¨€å¯¹é½è®­ç»ƒæµç¨‹"
  style: {
    font-size: 28
    bold: true
    underline: true
  }
}

# ============================================================
# æ•°æ®åŠ è½½
# ============================================================
data: {
  label: "æ•°æ®åŠ è½½"
  style: {
    fill: "#E3F2FD"
    stroke: "#1565C0"
    border-radius: 8
    font-size: 18
    bold: true
  }

  parquet: {
    label: "SA1B-Dense-Caption\nParquet æ–‡ä»¶"
    shape: cylinder
    style.fill: "#BBDEFB"
  }

  parse: {
    label: "è§£æ Parquet\nurl + cap_seg.global_caption"
    shape: rectangle
    style.fill: "#E3F2FD"
  }

  download: {
    label: "æŒ‰ URL ä¸‹è½½å›¾ç‰‡\nâ†’ PIL Image"
    shape: rectangle
    style.fill: "#E3F2FD"
  }

  sample: {
    label: "å–å‰ 100K æ ·æœ¬\n(Subset)"
    shape: rectangle
    style.fill: "#E3F2FD"
  }

  parquet -> parse -> download -> sample
}

# ============================================================
# å›¾åƒé¢„å¤„ç†
# ============================================================
img_preprocess: {
  label: "å›¾åƒé¢„å¤„ç†"
  style: {
    fill: "#FFF3E0"
    stroke: "#E65100"
    border-radius: 8
    font-size: 18
    bold: true
  }

  resize: {
    label: "Resize(224, BICUBIC)"
    style.fill: "#FFE0B2"
  }
  crop: {
    label: "CenterCrop(224)"
    style.fill: "#FFE0B2"
  }
  tensor: {
    label: "ToTensor()"
    style.fill: "#FFE0B2"
  }
  norm: {
    label: "Normalize\n(CLIP mean/std)"
    style.fill: "#FFE0B2"
  }
  img_out: {
    label: "pixel_values\n[B, 3, 224, 224]"
    shape: parallelogram
    style.fill: "#FFCC80"
  }

  resize -> crop -> tensor -> norm -> img_out
}

# ============================================================
# æ–‡æœ¬é¢„å¤„ç†
# ============================================================
txt_preprocess: {
  label: "æ–‡æœ¬é¢„å¤„ç† (build_qa_ids)"
  style: {
    fill: "#F3E5F5"
    stroke: "#6A1B9A"
    border-radius: 8
    font-size: 18
    bold: true
  }

  instruction: {
    label: "éšæœºé€‰å–æŒ‡ä»¤\nINSTRUCTION_POOL\n(å¦‚ \"æè¿°è¿™å¼ å›¾ç‰‡\")"
    shape: hexagon
    style.fill: "#E1BEE7"
  }

  qa_format: {
    label: "æ„é€  QA å¯¹\nQ: Qwen3 Chat Template\nA: Caption + EOS"
    style.fill: "#E1BEE7"
  }

  tokenize: {
    label: "Tokenize\n(max_len=128)"
    style.fill: "#E1BEE7"
  }

  labels_build: {
    label: "æ„å»º Labels\nQ éƒ¨åˆ† â†’ -100 (å¿½ç•¥)\nA éƒ¨åˆ† â†’ token IDs (ç›‘ç£)"
    style.fill: "#E1BEE7"
  }

  ids_out: {
    label: "input_ids [B, T]\nlabels [B, T]"
    shape: parallelogram
    style.fill: "#CE93D8"
  }

  instruction -> qa_format -> tokenize -> labels_build -> ids_out
}

# ============================================================
# Collate & DataLoader
# ============================================================
collate: {
  label: "Collate Function\nå †å å›¾åƒ + å¡«å……åºåˆ—åˆ°ç›¸åŒé•¿åº¦"
  shape: rectangle
  style: {
    fill: "#F1F8E9"
    stroke: "#33691E"
    font-size: 16
    border-radius: 8
  }
}

# ============================================================
# æ¨¡å‹å‰å‘ä¼ æ’­
# ============================================================
forward: {
  label: "æ¨¡å‹å‰å‘ä¼ æ’­"
  style: {
    fill: "#E8F5E9"
    stroke: "#1B5E20"
    border-radius: 8
    font-size: 18
    bold: true
  }

  clip: {
    label: "CLIPVisionTower\n(å†»ç»“ â„ï¸)\nChinese-CLIP ViT-B/16"
    shape: rectangle
    style: {
      fill: "#C8E6C9"
      stroke: "#2E7D32"
      stroke-dash: 5
    }
  }

  clip_out: {
    label: "è§†è§‰ç‰¹å¾\n[B, 197, 768]"
    shape: parallelogram
    style.fill: "#A5D6A7"
  }

  projection: {
    label: "MultimodalProjection\n(å¯è®­ç»ƒ ğŸ”¥)\nLinear(768â†’1024) â†’ GELU â†’ Linear(1024â†’1024)"
    shape: rectangle
    style: {
      fill: "#FF8A65"
      stroke: "#BF360C"
      stroke-width: 3
    }
  }

  proj_out: {
    label: "visual_embeds\n[B, 197, 1024]"
    shape: parallelogram
    style.fill: "#A5D6A7"
  }

  embed_tokens: {
    label: "llm.embed_tokens\n(Qwen3)"
    shape: rectangle
    style: {
      fill: "#C8E6C9"
      stroke: "#2E7D32"
      stroke-dash: 5
    }
  }

  text_embeds: {
    label: "text_embeds\n[B, T, 1024]"
    shape: parallelogram
    style.fill: "#A5D6A7"
  }

  concat_embeds: {
    label: "Concat Embeds\ntorch.cat([visual_embeds, text_embeds], dim=1)"
    shape: diamond
    style: {
      fill: "#DCEDC8"
      stroke: "#33691E"
    }
  }

  combined_embeds: {
    label: "combined_embeds\n[B, 197+T, 1024]"
    shape: parallelogram
    style.fill: "#A5D6A7"
  }

  # ---- æ„é€  combined_labels ----
  ignore_labels: {
    label: "æ„é€  ignore_labels\ntorch.full((B, 197), -100)\nè§†è§‰ token ä½ç½®ä¸è®¡ç®— loss"
    shape: rectangle
    style: {
      fill: "#FFECB3"
      stroke: "#FF6F00"
      stroke-width: 2
    }
  }

  concat_labels: {
    label: "Concat Labels\ntorch.cat([ignore_labels, labels], dim=1)"
    shape: diamond
    style: {
      fill: "#DCEDC8"
      stroke: "#33691E"
    }
  }

  combined_labels: {
    label: "combined_labels\n[B, 197+T]\n(å‰ 197 ä½ = -100, å T ä½ = åŸ labels)"
    shape: parallelogram
    style.fill: "#A5D6A7"
  }

  llm: {
    label: "Qwen3-0.6B\n(å†»ç»“ â„ï¸, gradient_checkpointing)\nFlash Attention 2, bf16"
    shape: rectangle
    style: {
      fill: "#C8E6C9"
      stroke: "#2E7D32"
      stroke-dash: 5
    }
  }

  loss: {
    label: "CrossEntropy Loss\n(ä»…è®¡ç®— Answer éƒ¨åˆ†)"
    shape: parallelogram
    style: {
      fill: "#FFCDD2"
      stroke: "#B71C1C"
      font-size: 16
      bold: true
    }
  }

  clip -> clip_out -> projection -> proj_out -> concat_embeds
  embed_tokens -> text_embeds -> concat_embeds
  concat_embeds -> combined_embeds

  proj_out -> ignore_labels: "num_visual_tokens = 197" {
    style: {
      stroke: "#FF6F00"
      stroke-dash: 3
    }
  }
  ignore_labels -> concat_labels
  concat_labels -> combined_labels

  combined_embeds -> llm
  combined_labels -> llm: "labels" {
    style: {
      stroke: "#FF6F00"
      stroke-width: 2
    }
  }
  llm -> loss
}

# ============================================================
# è®­ç»ƒå¾ªç¯
# ============================================================
training: {
  label: "è®­ç»ƒå¾ªç¯"
  style: {
    fill: "#FFF9C4"
    stroke: "#F57F17"
    border-radius: 8
    font-size: 18
    bold: true
  }

  backward: {
    label: "loss.backward()\næ¢¯åº¦ä»…æµå‘ Projection"
    style.fill: "#FFF59D"
  }

  optimizer: {
    label: "AdamW.step()\n(lr=2e-3, ä»…æ›´æ–° Projection)"
    style.fill: "#FFF59D"
  }

  scheduler: {
    label: "CosineScheduler.step()\n(warmup 3%)"
    style.fill: "#FFF59D"
  }

  zero_grad: {
    label: "optimizer.zero_grad()"
    style.fill: "#FFF59D"
  }

  backward -> optimizer -> scheduler -> zero_grad
}

# ============================================================
# æ—¥å¿—ä¸è¯„ä¼°
# ============================================================
logging: {
  label: "æ—¥å¿— & è¯„ä¼° & ä¿å­˜"
  style: {
    fill: "#FCE4EC"
    stroke: "#880E4F"
    border-radius: 8
    font-size: 18
    bold: true
  }

  log_step: {
    label: "æ¯ 10 æ­¥\næ‰“å° loss / perplexity / lr"
    shape: rectangle
    style.fill: "#F8BBD0"
  }

  eval_step: {
    label: "æ¯ 200 æ­¥\nåœ¨ eval set ä¸Šè¯„ä¼°\n(500 samples)"
    shape: rectangle
    style.fill: "#F8BBD0"
  }

  save_step: {
    label: "æ¯ 1000 æ­¥\nä¿å­˜ checkpoint\nstage1_projection_step{N}.pt"
    shape: rectangle
    style.fill: "#F8BBD0"
  }

  tensorboard: {
    label: "TensorBoard\ntrain/eval loss\nperplexity, lr"
    shape: cylinder
    style.fill: "#F48FB1"
  }

  log_step -> tensorboard
  eval_step -> tensorboard
}

# ============================================================
# æœ€ç»ˆè¾“å‡º
# ============================================================
final: {
  label: "è®­ç»ƒç»“æŸ"
  style: {
    fill: "#E0F7FA"
    stroke: "#006064"
    border-radius: 8
    font-size: 18
    bold: true
  }

  final_eval: {
    label: "å®Œæ•´ eval set è¯„ä¼°"
    style.fill: "#B2EBF2"
  }

  save_final: {
    label: "ä¿å­˜æœ€ç»ˆæƒé‡\nstage1_projection.pt"
    shape: cylinder
    style: {
      fill: "#80DEEA"
      stroke: "#006064"
      font-size: 16
      bold: true
    }
  }

  final_eval -> save_final
}

# ============================================================
# ä¸»æµç¨‹è¿æ¥
# ============================================================
data.sample -> img_preprocess.resize: "PIL Image" {
  style.stroke: "#E65100"
}
data.sample -> txt_preprocess.instruction: "global_caption" {
  style.stroke: "#6A1B9A"
}

img_preprocess.img_out -> collate: "pixel_values" {
  style.stroke: "#E65100"
}
txt_preprocess.ids_out -> collate: "input_ids + labels" {
  style.stroke: "#6A1B9A"
}

collate -> forward.clip: "pixel_values" {
  style.stroke: "#E65100"
}
collate -> forward.embed_tokens: "input_ids" {
  style.stroke: "#6A1B9A"
}
collate -> forward.concat_labels: "labels [B, T]" {
  style.stroke: "#FF6F00"
}

forward.loss -> training.backward: "loss" {
  style: {
    stroke: "#B71C1C"
    stroke-width: 2
  }
}

training.zero_grad -> forward.clip: "ä¸‹ä¸€ä¸ª batch" {
  style: {
    stroke: "#F57F17"
    stroke-dash: 5
  }
}

training.zero_grad -> logging.log_step: "å®šæœŸ" {
  style: {
    stroke: "#880E4F"
    stroke-dash: 5
  }
}
training.zero_grad -> logging.eval_step: "å®šæœŸ" {
  style: {
    stroke: "#880E4F"
    stroke-dash: 5
  }
}
training.zero_grad -> logging.save_step: "å®šæœŸ" {
  style: {
    stroke: "#880E4F"
    stroke-dash: 5
  }
}

logging.save_step -> final.final_eval: "è®­ç»ƒå®Œæˆå" {
  style: {
    stroke: "#006064"
    stroke-width: 2
  }
}
